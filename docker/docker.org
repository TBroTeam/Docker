* Installation for TBro using Docker containers

** General structure
   The Docker installation is separated into two independent containers:
   1) Database container
      - postgresql
      - CHADO database scheme plus modifications
      - AdminTools
   2) TBro Website
      - Apache2
      - php settings...
   3) memcached container
      Maybe better included into TBro website container
   4) Worker container

** Preparation
   #+BEGIN_SRC sh
     mkdir db_container
     mkdir apache_container
     mkdir memcached_container
     mkdir worker_container
     mkdir worker_db_container
     mkdir chado_create_container
   #+END_SRC

   According to the thesis of Lenz, it is required to install Chado
   1.2 separately. Therefore I need to download the Chado file first.
   #+BEGIN_SRC sh :dir db_container/
     wget -O chado-1.2.tar.gz 'http://downloads.sourceforge.net/project/gmod/gmod/chado-1.2/chado-1.2.tar.gz?r=http%3A%2F%2Fsourceforge.net%2Fprojects%2Fgmod%2Ffiles%2Fgmod%2Fchado-1.2%2F&ts=1415403627&use_mirror=kent'
   #+END_SRC

   Following the installation instructions from Lenz thesis, the next
   step is the reduction of the database scheme:
   #+BEGIN_SRC sh :dir db_container/
     # untar the chado archive
     tar xzf chado-1.2.tar.gz

     # change to newly created folder
     cd chado-1.2

     # follow the instructions of Lenz:
     cd modules
     perl bin/makedep.pl --modules general,cv,pub,organism,sequence,contact,companalysis,mage > default_schema.sql
     cd ../..

     # create a new archive used for later transfer to image
     tar czf chado-1.2.mod.tar.gz chado-1.2
   #+END_SRC

   Additionally, I have to download the obo file for GO terms and convert it into XML
   #+BEGIN_SRC sh :dir db_container/
     wget -O gene_ontology.1_2.obo 'http://www.geneontology.org/ontology/obo_format_1_2/gene_ontology.1_2.obo'

     # convertion into xml format this might need the installation of
     # additional packages and should be moved into the chade database
     # generation later
     go2fmt.pl -p obo_text -w xml gene_ontology.1_2.obo | go-apply-xslt oboxml_to_chadoxml - > g_o.1_2.chadoxml

     # generation of an tar archive for transfer into the container
     tar czf g_o.1_2.chadoxml.tar.gz  g_o.1_2.chadoxml
   #+END_SRC

** Database container
   We start from the default postgres container
   #+BEGIN_SRC sh :tangle db_container/Dockerfile
     FROM postgres:9.3
   #+END_SRC

   First we update our machine and install the required php packages
   #+BEGIN_SRC sh :tangle db_container/Dockerfile
     RUN apt-get update
   #+END_SRC

   #+BEGIN_SRC sh :tangle ./db_container/fix-acl.sh :shebang "#!/bin/bash"
     echo "******MODIFYING PG_HBA.CONF******"
     cat > /var/lib/postgresql/data/pg_hba.conf <<EOS
     # Generated by fix-acl.sh
     # TYPE  DATABASE        USER            ADDRESS                 METHOD
     # "local" is for Unix domain socket connections only
     local   all             all                                     trust
     # IPv4 local connections:
     host    all             all             127.0.0.1/32            trust
     # IPv6 local connections:
     host    all             all             ::1/128                 trust

     # Allow anyone to connect remotely so long as they have a valid username and
     # password.
     host all all 0.0.0.0/0 md5
     EOS
     echo ""
     echo "******MODIFYING PG_HBA.CONF FINISHED******"
   #+END_SRC

   #+BEGIN_SRC sh :tangle ./db_container/create_user_db.sh :shebang "#!/bin/bash"
     # Check if the environment variables CHADO_* exist otherwise take default values
     CHADO_DB=${CHADO_DB:-chado}
     CHADO_PW=${CHADO_PASSWORD:-tbro}
     CHADO_USER=${CHADO_USER:-tbro}
     echo "******CREATING DOCKER DATABASE******"
     gosu postgres postgres --single <<- EOSQL
        CREATE DATABASE $CHADO_DB;
        CREATE ROLE $CHADO_USER ENCRYPTED PASSWORD '$CHADO_PW' NOSUPERUSER CREATEDB NOCREATEROLE INHERIT LOGIN;
        ALTER DATABASE $CHADO_DB OWNER TO $CHADO_USER;
        GRANT ALL PRIVILEGES ON DATABASE $CHADO_DB to $CHADO_USER;
     EOSQL
     echo ""
     echo "******DOCKER DATABASE CREATED******"
   #+END_SRC

   Finally I have to add a user to the database
   #+BEGIN_SRC sh :tangle db_container/Dockerfile
     ADD fix-acl.sh /docker-entrypoint-initdb.d/
     ADD create_user_db.sh /docker-entrypoint-initdb.d/
   #+END_SRC

   Now we can build and run the image
   #+BEGIN_SRC sh :dir db_container
     docker build --tag chado_db .
     docker run -d -e CHADO_DB=chado -e CHADO_USER=tbro -e CHADO_PW=tbro --name "Chado_DB_4_TBro" chado_db
   #+END_SRC

** Apache container
   We start from the default postgres container
   #+BEGIN_SRC sh :tangle apache_container/Dockerfile
     FROM ubuntu
   #+END_SRC

   First we update our machine and install the required php packages
   #+BEGIN_SRC sh :tangle apache_container/Dockerfile
     RUN apt-get update
     RUN apt-get --assume-yes install \
         apache2 \
         php5 \
         php-pear \
         php5-pgsql \
         php5-curl \
         php5-dev \
         build-essential
   #+END_SRC

   Next we need to install phing
   #+BEGIN_SRC sh :tangle apache_container/Dockerfile
     RUN pear channel-discover pear.phing.info
     RUN pear install --alldeps phing/phing
     RUN pear channel-discover pear.propelorm.org
     RUN pear install -a propel/propel_runtime
     RUN pear install Log
     RUN pear install Console_CommandLine
     #RUN pear install Console_Table
     RUN pear install channel://pear.php.net/Console_ProgressBar-0.5.2beta
   #+END_SRC

   Modify php.ini to diable phar.readonly
   #+BEGIN_SRC sh :tangle apache_container/Dockerfile
     RUN sed -i '/phar.readonly = /s/^.*/phar.readonly = Off/' /etc/php5/cli/php.ini
   #+END_SRC

   We have to enable mod_rewrite
   #+BEGIN_SRC sh :tangle apache_container/Dockerfile
     RUN a2enmod rewrite
   #+END_SRC

   Generate a TBro image from the commit  82c52be7f
   #+BEGIN_SRC sh :dir ../
     git archive --format tar.gz --output docker/82c52be7f_Tbro.tar.gz 82c52be7f
   #+END_SRC

   And copy the TBro archive to the image
   #+BEGIN_SRC sh :tangle apache_container/Dockerfile
     ADD 82c52be7f_Tbro.tar.gz /home/
   #+END_SRC

   Finally we start the apache instance
   #+BEGIN_SRC sh :tangle apache_container/Dockerfile
     CMD service apache2 start; while true; do sleep 60; done
   #+END_SRC

** Installation of Chado database
   #+BEGIN_SRC sh
     export CHADO_DB_NAME="chado"
     export CHADO_DB_USERNAME="tbro"
     export CHADO_DB_PASSWORD="tbro"
     export CHADO_DB_HOST="localhost"
     export CHADO_DB_PORT="5432"

     mkdir -p /usr/local/gmod
     export GMOD_ROOT=/usr/local/gmod

     cd /tmp/chado-1.2/

     # remove old build.conf if existing
     if [ -e build.conf ]
     then
         rm build.conf
     fi

     # run the Makefile.PL generator
     echo "" | perl Makefile.PL

     # the installation name for stag-storenode does not end by an .pl
     # to circumstand the wrong name I am generating links with the expected names
     ln -s $(which stag-storenode) $(dirname $(which stag-storenode))/stag-storenode.pl


     # run the make commands
     make
     make install
     make load_schema
     make prepdb
     make ontologies <<EOF
     1,2
     EOF

     # install the prepared GO 1.2
     stag-storenode.pl \
         -d 'dbi:Pg:dbname='$CHADO_DB_NAME';host='$CHADO_DB_HOST';port='$CHADO_DB_PORT \
         --user "$CHADO_DB_USERNAME" \
         --password "$CHADO_DB_PASSWORD" \
         ../g_o.1_2.chadoxml

     # make the optional targets
     make rm_locks
     make clean
   #+END_SRC

** Worker database
   We start from the default postgres container
   #+BEGIN_SRC sh :tangle worker_db_container/Dockerfile
     FROM postgres:9.3
   #+END_SRC

   #+BEGIN_SRC sh :tangle ./worker_db_container/fix-acl.sh :shebang "#!/bin/bash"
     echo "******MODIFYING PG_HBA.CONF******"
     cat > /var/lib/postgresql/data/pg_hba.conf <<EOS
     # Generated by fix-acl.sh
     # TYPE  DATABASE        USER            ADDRESS                 METHOD
     # "local" is for Unix domain socket connections only
     local   all             all                                     trust
     # IPv4 local connections:
     host    all             all             127.0.0.1/32            trust
     # IPv6 local connections:
     host    all             all             ::1/128                 trust

     # Allow anyone to connect remotely so long as they have a valid username and
     # password.
     host all all 0.0.0.0/0 md5
     EOS
     echo ""
     echo "******MODIFYING PG_HBA.CONF FINISHED******"
   #+END_SRC

   #+BEGIN_SRC sh :tangle ./worker_db_container/create_user_db.sh :shebang "#!/bin/bash"
     # Check if the environment variables WORKER_* exist otherwise take default values
     WORKER_DB=${WORKER_DB:-worker}
     WORKER_PW=${WORKER_PW:-worker}
     WORKER_USER=${WORKER_USER:-worker}
     echo "******CREATING DOCKER DATABASE******"
     gosu postgres postgres --single <<- EOSQL
        CREATE DATABASE $WORKER_DB;
        CREATE ROLE $WORKER_USER ENCRYPTED PASSWORD '$WORKER_PW' NOSUPERUSER CREATEDB NOCREATEROLE INHERIT LOGIN;
        ALTER DATABASE $WORKER_DB OWNER TO $WORKER_USER;
        GRANT ALL PRIVILEGES ON DATABASE $WORKER_DB to $WORKER_USER;
     EOSQL
     echo ""
     echo "******DOCKER DATABASE CREATED******"
   #+END_SRC

   Finally I have to add a user to the database
   #+BEGIN_SRC sh :tangle worker_db_container/Dockerfile
     ADD fix-acl.sh /docker-entrypoint-initdb.d/
     ADD create_user_db.sh /docker-entrypoint-initdb.d/
   #+END_SRC

   Create the worker_db_image
   #+BEGIN_SRC sh
     docker build --tag "tbro_worker_db" .
     docker run -d -e WORKER_DB=worker -e WORKER_USER=worker -e WORKER_PW=worker --name "Worker_DB_4_TBro" tbro_worker_db
   #+END_SRC
